name: 'Apply terraform'
description: 'Configure terraform for work with dust repos and apply it'
inputs:
  working-directory:
    required: true
    default: 'tf'
  stage:
    required: true
    default: 'dev'

runs:
  using: "composite"
  steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ID_${{ inputs.stage }} }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_${{ inputs.stage }} }}
        aws-region: eu-central-1

    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.5.2
      with:
        ssh-private-key: ${{ secrets.GIT_READ_KEY }}

    - uses: hashicorp/setup-terraform@v1

    - name: Terraform init
      run: |
        terraform init
        terraform apply -auto-approve
      working-directory: ${{ inputs.working-directory }}

    - name: Terraform apply
      run:
      working-directory: tf
